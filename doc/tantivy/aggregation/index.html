<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Aggregations"><title>tantivy::aggregation - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-c4dbdcde0fbd8430.css" id="mainThemeStyle"><div id="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="tantivy" data-themes="" data-resource-suffix="" data-rustdoc-version="1.70.0-nightly (a266f1199 2023-03-22)" data-search-js="search-a6dd7f063a44c279.js" data-settings-js="settings-f0c5c39777a9a2f6.js" data-settings-css="settings-0bcba95ff279c1db.css" data-theme-light-css="light-db279b6232be9c13.css" data-theme-dark-css="dark-cf923f49f397b216.css" data-theme-ayu-css="ayu-be46fdc453a55015.css" ></div><script src="../../static.files/storage-9184409068f70b79.js"></script><script defer src="../../static.files/main-f5a2577c5297a973.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../../static.files/light-db279b6232be9c13.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../../static.files/dark-cf923f49f397b216.css"><link rel="stylesheet" href="../../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../tantivy/index.html"><img src="http://fulmicoton.com/tantivy-logo/tantivy-logo.png" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../tantivy/index.html"><img src="http://fulmicoton.com/tantivy-logo/tantivy-logo.png" alt="logo"></a><h2 class="location"><a href="#">Module aggregation</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#constants">Constants</a></li><li><a href="#types">Type Definitions</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../index.html">tantivy</a>::<wbr><a class="mod" href="#">aggregation</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../../src/tantivy/aggregation/mod.rs.html#1-1617">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="aggregations"><a href="#aggregations">Aggregations</a></h2>
<p>An aggregation summarizes your data as statistics on buckets or metrics.</p>
<p>Aggregations can provide answer to questions like:</p>
<ul>
<li>What is the average price of all sold articles?</li>
<li>How many errors with status code 500 do we have per day?</li>
<li>What is the average listing price of cars grouped by color?</li>
</ul>
<p>There are two categories: <a href="metric/index.html" title="mod tantivy::aggregation::metric">Metrics</a> and <a href="bucket/index.html" title="mod tantivy::aggregation::bucket">Buckets</a>.</p>
<h3 id="prerequisite"><a href="#prerequisite">Prerequisite</a></h3>
<p>Currently aggregations work only on <a href="../fastfield/index.html" title="mod tantivy::fastfield">fast fields</a>. Single value fast fields
of type <code>u64</code>, <code>f64</code>, <code>i64</code>, <code>date</code> and fast fields on text fields.</p>
<h3 id="usage"><a href="#usage">Usage</a></h3>
<p>To use aggregations, build an aggregation request by constructing
<a href="agg_req/type.Aggregations.html" title="type tantivy::aggregation::agg_req::Aggregations"><code>Aggregations</code></a>.
Create an <a href="struct.AggregationCollector.html" title="struct tantivy::aggregation::AggregationCollector"><code>AggregationCollector</code></a> from this request. <code>AggregationCollector</code> implements the
<a href="../collector/trait.Collector.html" title="trait tantivy::collector::Collector"><code>Collector</code></a> trait and can be passed as collector into
<a href="../struct.Searcher.html#method.search" title="method tantivy::Searcher::search"><code>Searcher::search()</code></a>.</p>
<h3 id="json-format"><a href="#json-format">JSON Format</a></h3>
<p>Aggregations request and result structures de/serialize into elasticsearch compatible JSON.</p>
<div class="example-wrap"><pre class="language-verbatim"><code>let agg_req: Aggregations = serde_json::from_str(json_request_string).unwrap();
let collector = AggregationCollector::from_aggs(agg_req, None);
let searcher = reader.searcher();
let agg_res = searcher.search(&amp;term_query, &amp;collector).unwrap_err();
let json_response_string: String = &amp;serde_json::to_string(&amp;agg_res)?;
</code></pre></div><h3 id="supported-aggregations"><a href="#supported-aggregations">Supported Aggregations</a></h3>
<ul>
<li><a href="bucket/index.html" title="mod tantivy::aggregation::bucket">Bucket</a>
<ul>
<li><a href="bucket/struct.HistogramAggregation.html" title="struct tantivy::aggregation::bucket::HistogramAggregation">Histogram</a></li>
<li><a href="agg_req/struct.RangeAggregation.html" title="struct tantivy::aggregation::agg_req::RangeAggregation">Range</a></li>
<li><a href="bucket/struct.TermsAggregation.html" title="struct tantivy::aggregation::bucket::TermsAggregation">Terms</a></li>
</ul>
</li>
<li><a href="metric/index.html" title="mod tantivy::aggregation::metric">Metric</a>
<ul>
<li><a href="metric/struct.AverageAggregation.html" title="struct tantivy::aggregation::metric::AverageAggregation">Average</a></li>
<li><a href="metric/struct.StatsAggregation.html" title="struct tantivy::aggregation::metric::StatsAggregation">Stats</a></li>
</ul>
</li>
</ul>
<h2 id="example"><a href="#example">Example</a></h2>
<p>Compute the average metric, by building <a href="agg_req/type.Aggregations.html" title="type tantivy::aggregation::agg_req::Aggregations"><code>agg_req::Aggregations</code></a>, which is built from an
<code>(String, agg_req::Aggregation)</code> iterator.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>tantivy::aggregation::agg_req::{Aggregations, Aggregation, MetricAggregation};
<span class="kw">use </span>tantivy::aggregation::AggregationCollector;
<span class="kw">use </span>tantivy::aggregation::metric::AverageAggregation;
<span class="kw">use </span>tantivy::query::AllQuery;
<span class="kw">use </span>tantivy::aggregation::agg_result::AggregationResults;
<span class="kw">use </span>tantivy::IndexReader;
<span class="kw">use </span>tantivy::schema::Schema;

<span class="kw">fn </span>aggregate_on_index(reader: <span class="kw-2">&amp;</span>IndexReader, schema: Schema) {
    <span class="kw">let </span>agg_req: Aggregations = <span class="macro">vec!</span>[
    (
            <span class="string">&quot;average&quot;</span>.to_string(),
            Aggregation::Metric(MetricAggregation::Average(
                AverageAggregation::from_field_name(<span class="string">&quot;score&quot;</span>.to_string()),
            )),
        ),
    ]
    .into_iter()
    .collect();

    <span class="kw">let </span>collector = AggregationCollector::from_aggs(agg_req, <span class="prelude-val">None</span>, schema);

    <span class="kw">let </span>searcher = reader.searcher();
    <span class="kw">let </span>agg_res: AggregationResults = searcher.search(<span class="kw-2">&amp;</span>AllQuery, <span class="kw-2">&amp;</span>collector).unwrap();
}</code></pre></div>
<h2 id="example-json"><a href="#example-json">Example JSON</a></h2>
<p>Requests are compatible with the elasticsearch json request format.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>tantivy::aggregation::agg_req::Aggregations;

<span class="kw">let </span>elasticsearch_compatible_json_req = <span class="string">r#&quot;
{
  &quot;average&quot;: {
    &quot;avg&quot;: { &quot;field&quot;: &quot;score&quot; }
  },
  &quot;range&quot;: {
    &quot;range&quot;: {
      &quot;field&quot;: &quot;score&quot;,
      &quot;ranges&quot;: [
        { &quot;to&quot;: 3.0 },
        { &quot;from&quot;: 3.0, &quot;to&quot;: 7.0 },
        { &quot;from&quot;: 7.0, &quot;to&quot;: 20.0 },
        { &quot;from&quot;: 20.0 }
      ]
    },
    &quot;aggs&quot;: {
      &quot;average_in_range&quot;: { &quot;avg&quot;: { &quot;field&quot;: &quot;score&quot; } }
    }
  }
}
&quot;#</span>;
<span class="kw">let </span>agg_req: Aggregations =
    serde_json::from_str(elasticsearch_compatible_json_req).unwrap();</code></pre></div>
<h2 id="code-organization"><a href="#code-organization">Code Organization</a></h2>
<p>Check the <a href="https://github.com/quickwit-oss/tantivy/tree/main/src/aggregation#readme">README</a> on github to see how the code is organized.</p>
<h2 id="nested-aggregation"><a href="#nested-aggregation">Nested Aggregation</a></h2>
<p>Buckets can contain sub-aggregations. In this example we create buckets with the range
aggregation and then calculate the average on each bucket.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>tantivy::aggregation::agg_req::<span class="kw-2">*</span>;
<span class="kw">use </span>tantivy::aggregation::metric::AverageAggregation;
<span class="kw">use </span>tantivy::aggregation::bucket::RangeAggregation;
<span class="kw">let </span>sub_agg_req_1: Aggregations = <span class="macro">vec!</span>[(
   <span class="string">&quot;average_in_range&quot;</span>.to_string(),
        Aggregation::Metric(MetricAggregation::Average(
            AverageAggregation::from_field_name(<span class="string">&quot;score&quot;</span>.to_string()),
        )),
)]
.into_iter()
.collect();

<span class="kw">let </span>agg_req_1: Aggregations = <span class="macro">vec!</span>[
    (
        <span class="string">&quot;range&quot;</span>.to_string(),
        Aggregation::Bucket(BucketAggregation {
            bucket_agg: BucketAggregationType::Range(RangeAggregation{
                field: <span class="string">&quot;score&quot;</span>.to_string(),
                ranges: <span class="macro">vec!</span>[(<span class="number">3f64</span>..<span class="number">7f64</span>).into(), (<span class="number">7f64</span>..<span class="number">20f64</span>).into()],
                keyed: <span class="bool-val">false</span>,
            }),
            sub_aggregation: sub_agg_req_1.clone(),
        }),
    ),
]
.into_iter()
.collect();</code></pre></div>
<h2 id="distributed-aggregation"><a href="#distributed-aggregation">Distributed Aggregation</a></h2>
<p>When the data is distributed on different <a href="../struct.Index.html" title="struct tantivy::Index"><code>Index</code></a> instances, the
<a href="struct.DistributedAggregationCollector.html" title="struct tantivy::aggregation::DistributedAggregationCollector"><code>DistributedAggregationCollector</code></a> provides functionality to merge data between independent
search calls by returning
<a href="intermediate_agg_result/struct.IntermediateAggregationResults.html" title="struct tantivy::aggregation::intermediate_agg_result::IntermediateAggregationResults"><code>IntermediateAggregationResults</code></a>.
<code>IntermediateAggregationResults</code> provides the
<a href="intermediate_agg_result/struct.IntermediateAggregationResults.html#method.merge_fruits" title="method tantivy::aggregation::intermediate_agg_result::IntermediateAggregationResults::merge_fruits"><code>merge_fruits</code></a> method
to merge multiple results. The merged result can then be converted into
<a href="agg_result/struct.AggregationResults.html" title="struct tantivy::aggregation::agg_result::AggregationResults"><code>AggregationResults</code></a> via the
<a href="intermediate_agg_result/struct.IntermediateAggregationResults.html#method.into_final_bucket_result" title="method tantivy::aggregation::intermediate_agg_result::IntermediateAggregationResults::into_final_bucket_result"><code>into_final_bucket_result</code></a> method.</p>
</div></details><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="agg_req/index.html" title="mod tantivy::aggregation::agg_req">agg_req</a></div><div class="desc docblock-short">Contains the aggregation request tree. Used to build an
<a href="struct.AggregationCollector.html" title="struct tantivy::aggregation::AggregationCollector"><code>AggregationCollector</code></a>.</div></li><li><div class="item-name"><a class="mod" href="agg_result/index.html" title="mod tantivy::aggregation::agg_result">agg_result</a></div><div class="desc docblock-short">Contains the final aggregation tree.
This tree can be converted via the <code>into()</code> method from <code>IntermediateAggregationResults</code>.
This conversion computes the final result. For example: The intermediate result contains
intermediate average results, which is the sum and the number of values. The actual average is
calculated on the step from intermediate to final aggregation result tree.</div></li><li><div class="item-name"><a class="mod" href="bucket/index.html" title="mod tantivy::aggregation::bucket">bucket</a></div><div class="desc docblock-short">Module for all bucket aggregations.</div></li><li><div class="item-name"><a class="mod" href="intermediate_agg_result/index.html" title="mod tantivy::aggregation::intermediate_agg_result">intermediate_agg_result</a></div><div class="desc docblock-short">Contains the intermediate aggregation tree, that can be merged.
Intermediate aggregation results can be used to merge results between segments or between
indices.</div></li><li><div class="item-name"><a class="mod" href="metric/index.html" title="mod tantivy::aggregation::metric">metric</a></div><div class="desc docblock-short">Module for all metric aggregations.</div></li></ul><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.AggregationCollector.html" title="struct tantivy::aggregation::AggregationCollector">AggregationCollector</a></div><div class="desc docblock-short">Collector for aggregations.</div></li><li><div class="item-name"><a class="struct" href="struct.AggregationSegmentCollector.html" title="struct tantivy::aggregation::AggregationSegmentCollector">AggregationSegmentCollector</a></div><div class="desc docblock-short"><code>AggregationSegmentCollector</code> does the aggregation collection on a segment.</div></li><li><div class="item-name"><a class="struct" href="struct.DistributedAggregationCollector.html" title="struct tantivy::aggregation::DistributedAggregationCollector">DistributedAggregationCollector</a></div><div class="desc docblock-short">Collector for distributed aggregations.</div></li></ul><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.Key.html" title="enum tantivy::aggregation::Key">Key</a></div><div class="desc docblock-short">The key to identify a bucket.</div></li></ul><h2 id="constants" class="small-section-header"><a href="#constants">Constants</a></h2><ul class="item-table"><li><div class="item-name"><a class="constant" href="constant.MAX_BUCKET_COUNT.html" title="constant tantivy::aggregation::MAX_BUCKET_COUNT">MAX_BUCKET_COUNT</a></div><div class="desc docblock-short">The default max bucket count, before the aggregation fails.</div></li></ul><h2 id="types" class="small-section-header"><a href="#types">Type Definitions</a></h2><ul class="item-table"><li><div class="item-name"><a class="type" href="type.SerializedKey.html" title="type tantivy::aggregation::SerializedKey">SerializedKey</a></div><div class="desc docblock-short">The serialized key is used in a <code>HashMap</code>.</div></li></ul></section></div></main></body></html>